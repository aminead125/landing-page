<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Cash on Delivery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Transition de la largeur de la sidebar */
    .sidebar {
      transition: width 0.3s ease;
    }
    /* Mode développé (par défaut) : largeur complète */
    .sidebar.expanded {
      width: 18rem;
    }
    /* Mode réduit : largeur minimale pour afficher les icônes */
    .sidebar.collapsed {
      width: 4rem;
    }
    /* Transition pour masquer/afficher le texte du menu */
    .menu-text {
      transition: opacity 0.3s ease;
    }
    /* En mode réduit, on masque le texte des éléments de menu */
    .sidebar.collapsed .menu-text {
      display: none;
    }
    /* En mode réduit, on masque l'icône COD Admin */
    .sidebar.collapsed .cod-admin-icon {
      display: none;
    }
    /* Ajustement du contenu principal en fonction de la sidebar */
    .content-shifted {
      transition: margin-left 0.3s ease;
      margin-left: 18rem;
    }
    .content-collapsed {
      transition: margin-left 0.3s ease;
      margin-left: 4rem;
    }
    
    /* Nouveaux styles pour gérer les icônes en mode réduit */
    .sidebar.collapsed .menu-icon {
      margin-right: 0;
      display: flex;
      justify-content: center;
      width: 100%;
    }
    
    .sidebar a {
      transition: all 0.3s ease;
    }
    
    .sidebar.collapsed a {
      justify-content: center;
      padding-left: 0;
      padding-right: 0;
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar fixed left-0 top-0 bg-white text-gray-700 p-5 flex flex-col h-screen shadow-lg overflow-y-auto z-40 expanded">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center gap-3">
        <svg class="w-8 h-8 text-blue-500 cod-admin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="2" y="5" width="20" height="14" rx="2"></rect>
          <line x1="2" y1="10" x2="22" y2="10"></line>
        </svg>
        <h2 class="text-2xl font-bold text-blue-500 menu-text">COD Admin</h2>
      </div>
      <button id="menu-btn" class="p-2 bg-gray-100 text-gray-700 rounded-lg" aria-label="Toggle menu">
        &#9776;
      </button>
    </div>
    <!-- Menu -->
    <ul class="space-y-4">
      <li>
        <a href="../admin-dash.html" class="flex items-center px-4 py-3 rounded-lg bg-blue-100 text-blue-500">
          <svg class="w-5 h-5 mr-3 menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <polyline points="9 22 9 12 15 12 15 22"></polyline>
          </svg>
          <span class="menu-text">Tableau de bord</span>
        </a>
      </li>
      <li>
        <a href="Commandes.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 transition">
          <svg class="w-5 h-5 mr-3 menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <span class="menu-text">Commandes</span>
        </a>
      </li>
      <li>
        <a href="livraisons.html" class="flex items-center px-4 py-3 rounded-lg hover:bg-gray-100 transition">
          <svg class="w-5 h-5 mr-3 menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="3" width="15" height="13"></rect>
            <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>
            <circle cx="5.5" cy="18.5" r="2.5"></circle>
            <circle cx="18.5" cy="18.5" r="2.5"></circle>
          </svg>
          <span class="menu-text">Livraisons</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- Contenu principal -->
  <div id="main-content" class="p-8 content-shifted transition-all duration-300">
    <header class="bg-white shadow-sm p-4 rounded-xl flex justify-between items-center mb-8">
      <div class="relative w-1/3">
        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
        </svg>
        <input type="text" placeholder="Rechercher des commandes..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
      </div>
      <div class="flex items-center gap-4">
        <button class="relative p-2" aria-label="Notifications">
          <svg class="w-6 h-6 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
          </svg>
          <span class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 rounded-full text-xs flex items-center justify-center">3</span>
        </button>
        <div class="w-10 h-10 rounded-full bg-blue-100 overflow-hidden">
          <img src="/api/placeholder/40/40" alt="Avatar" class="w-full h-full object-cover">
        </div>
      </div>
    </header>

    <!-- Section des commandes -->
    <div class="mb-8">
      <section class="bg-white p-6 rounded-xl shadow overflow-x-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold">Commandes à confirmer</h2>
        </div>
        <table class="w-full border-collapse">
          <thead>
            <tr class="text-gray-500 border-b">
              <th class="px-4 py-3 text-center font-medium">ID</th>
              <th class="px-4 py-3 text-center font-medium">Client</th>
              <th class="px-4 py-3 text-center font-medium">Téléphone</th>
              <th class="px-4 py-3 text-center font-medium">Province</th>
              <th class="px-4 py-3 text-center font-medium">Adresse</th>
              <th class="px-4 py-3 text-center font-medium">Quantité</th>
              <th class="px-4 py-3 text-center font-medium">Montant</th>
              <th class="px-4 py-3 text-center font-medium">Statut</th>
              <th class="px-4 py-3 text-center font-medium">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Les commandes seront chargées ici via JavaScript -->
          </tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- Script pour la sidebar, le chargement et la mise à jour des commandes -->
  <script>
    // Gestion du basculement de la sidebar
    document.addEventListener('DOMContentLoaded', function() {
      const menuBtn = document.getElementById('menu-btn');
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      let isExpanded = true;
      
      menuBtn.addEventListener('click', function() {
        if (isExpanded) {
          sidebar.classList.remove('expanded');
          sidebar.classList.add('collapsed');
          mainContent.classList.remove('content-shifted');
          mainContent.classList.add('content-collapsed');
          isExpanded = false;
        } else {
          sidebar.classList.remove('collapsed');
          sidebar.classList.add('expanded');
          mainContent.classList.remove('content-collapsed');
          mainContent.classList.add('content-shifted');
          isExpanded = true;
        }
      });
    });

    // Fonction pour charger les commandes
    async function loadCommandes() {
      try {
        const response = await fetch('http://localhost:5000/api/commande');
        const result = await response.json();
        if (result.success) {
          const commandes = result.data;
          const tableBody = document.querySelector('table tbody');
          tableBody.innerHTML = '';

          commandes.forEach(commande => {
            const tr = document.createElement('tr');
            tr.classList.add('hover:bg-gray-50', 'transition', 'border-b');
            
            tr.innerHTML = `
              <td class="px-4 py-4 text-center">#${commande.commande_id}</td>
              <td class="px-4 py-4 text-center">${commande.nom} ${commande.prenom}</td>
              <td class="px-4 py-4 text-center">${commande.telephone}</td>
              <td class="px-4 py-4 text-center">${commande.province}</td>
              <td class="px-4 py-4 text-center">${commande.adresse}</td>
              <td class="px-4 py-4 text-center">${commande.quantite}</td>
              <td class="px-4 py-4 text-center">${commande.montant_total ? commande.montant_total + ' DZD' : 'N/A'}</td>
              <td class="px-4 py-4 text-center">
                <span class="px-2 py-1 text-center ${
                  commande.statut_libelle === 'confirmée'
                    ? 'bg-blue-100 text-blue-800'
                    : 'bg-red-100 text-red-800'
                } rounded-full text-xs font-medium">
                  ${commande.statut_libelle || 'N/A'}
                </span>
                ${commande.statut_libelle !== 'confirmée' ? `
                  <button 
                    class="ml-2 px-2 py-1 bg-green-100 text-green-800 rounded text-xs text-center"
                    onclick="updateStatutCommande(${commande.commande_id}, 2)">
                    Confirmer
                  </button>
                ` : ''}
              </td>
              <td class="px-4 py-4 text-center">
                <button onclick="deleteCommande(${commande.commande_id})" class="text-red-500 hover:text-red-700">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6l-2 14a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L5 6"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                  </svg>
                </button>
              </td>
            `;
            tableBody.appendChild(tr);
          });
        } else {
          console.error("Erreur: ", result.message);
        }
      } catch (error) {
        console.error("Erreur lors du chargement des commandes :", error);
      }
    }

    // Fonction pour mettre à jour le statut d'une commande
    async function updateStatutCommande(commandeId, newStatut) {
      try {
        const response = await fetch(`http://localhost:5000/api/commande/${commandeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ statut: newStatut })
        });
        const result = await response.json();

        if (result.success) {
          // Recharge la liste pour refléter la mise à jour
          loadCommandes();
        } else {
          console.error("Erreur lors de la mise à jour :", result.message);
          alert("Impossible de mettre à jour le statut.");
        }
      } catch (error) {
        console.error("Erreur lors de la mise à jour :", error);
        alert("Erreur lors de la mise à jour du statut.");
      }
    }

    // Fonction pour supprimer une commande
    async function deleteCommande(commandeId) {
      if (!confirm("Voulez-vous vraiment supprimer cette commande ?")) {
        return;
      }

      try {
        const response = await fetch(`http://localhost:5000/api/commande/${commandeId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await response.json();

        if (result.success) {
          alert("Commande supprimée avec succès.");
          loadCommandes(); // Rafraîchir la liste après suppression
        } else {
          console.error("Erreur :", result.message);
          alert("Impossible de supprimer la commande.");
        }
      } catch (error) {
        console.error("Erreur lors de la suppression :", error);
        alert("Erreur lors de la suppression de la commande.");
      }
    }

    // Charger les commandes au démarrage
    document.addEventListener('DOMContentLoaded', loadCommandes);
  </script>
</body>
</html>
